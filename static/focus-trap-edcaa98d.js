import{aV as e,o as t,aO as n,S as o,K as s,r as a,d as r,p as u,R as c,f as d,_ as i,a2 as l,V as f,e as p}from"./index-24d2acc3.js";import{i as v}from"./event-22bc0892.js";const m=(...t)=>n=>{t.forEach((t=>{e(t)?t(n):t.value=n}))};let E=[];const y=e=>{const t=e;t.key===s.esc&&E.forEach((e=>e(t)))},w="focus-trap.focus-after-trapped",L="focus-trap.focus-after-released",h={cancelable:!0,bubbles:!1},T={cancelable:!0,bubbles:!1},b="focusAfterTrapped",k="focusAfterReleased",R=Symbol("elFocusTrap"),g=a(),F=a(0),K=a(0);let S=0;const N=e=>{const t=[],n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>{const t="INPUT"===e.tagName&&"hidden"===e.type;return e.disabled||e.hidden||t?NodeFilter.FILTER_SKIP:e.tabIndex>=0||e===document.activeElement?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});for(;n.nextNode();)t.push(n.currentNode);return t},P=(e,t)=>{for(const n of e)if(!I(n,t))return n},I=(e,t)=>{if("hidden"===getComputedStyle(e).visibility)return!0;for(;e;){if(t&&e===t)return!1;if("none"===getComputedStyle(e).display)return!0;e=e.parentElement}return!1},_=(e,t)=>{if(e&&e.focus){const n=document.activeElement;e.focus({preventScroll:!0}),K.value=window.performance.now(),e!==n&&(e=>e instanceof HTMLInputElement&&"select"in e)(e)&&t&&e.select()}};function C(e,t){const n=[...e],o=e.indexOf(t);return-1!==o&&n.splice(o,1),n}const x=(()=>{let e=[];return{push:t=>{const n=e[0];n&&t!==n&&n.pause(),e=C(e,t),e.unshift(t)},remove:t=>{var n,o;e=C(e,t),null==(o=null==(n=e[0])?void 0:n.resume)||o.call(n)}}})(),A=()=>{g.value="pointer",F.value=window.performance.now()},O=()=>{g.value="keyboard",F.value=window.performance.now()},j=e=>new CustomEvent("focus-trap.focusout-prevented",{...T,detail:e});var D=i(r({name:"ElFocusTrap",inheritAttrs:!1,props:{loop:Boolean,trapped:Boolean,focusTrapEl:Object,focusStartEl:{type:[Object,String],default:"first"}},emits:[b,k,"focusin","focusout","focusout-prevented","release-requested"],setup(e,{emit:r}){const i=a();let p,m;const{focusReason:T}=(t((()=>{0===S&&(document.addEventListener("mousedown",A),document.addEventListener("touchstart",A),document.addEventListener("keydown",O)),S++})),o((()=>{S--,S<=0&&(document.removeEventListener("mousedown",A),document.removeEventListener("touchstart",A),document.removeEventListener("keydown",O))})),{focusReason:g,lastUserFocusTimestamp:F,lastAutomatedFocusTimestamp:K});var I;I=t=>{e.trapped&&!C.paused&&r("release-requested",t)},t((()=>{0===E.length&&document.addEventListener("keydown",y),n&&E.push(I)})),o((()=>{E=E.filter((e=>e!==I)),0===E.length&&n&&document.removeEventListener("keydown",y)}));const C={paused:!1,pause(){this.paused=!0},resume(){this.paused=!1}},D=t=>{if(!e.loop&&!e.trapped)return;if(C.paused)return;const{key:n,altKey:o,ctrlKey:a,metaKey:u,currentTarget:c,shiftKey:d}=t,{loop:i}=e,l=n===s.tab&&!o&&!a&&!u,f=document.activeElement;if(l&&f){const e=c,[n,o]=(e=>{const t=N(e);return[P(t,e),P(t.reverse(),e)]})(e);if(n&&o)if(d||f!==o){if(d&&[n,e].includes(f)){const e=j({focusReason:T.value});r("focusout-prevented",e),e.defaultPrevented||(t.preventDefault(),i&&_(o,!0))}}else{const e=j({focusReason:T.value});r("focusout-prevented",e),e.defaultPrevented||(t.preventDefault(),i&&_(n,!0))}else if(f===e){const e=j({focusReason:T.value});r("focusout-prevented",e),e.defaultPrevented||t.preventDefault()}}};u(R,{focusTrapRef:i,onKeydown:D}),c((()=>e.focusTrapEl),(e=>{e&&(i.value=e)}),{immediate:!0}),c([i],(([e],[t])=>{e&&(e.addEventListener("keydown",D),e.addEventListener("focusin",H),e.addEventListener("focusout",M)),t&&(t.removeEventListener("keydown",D),t.removeEventListener("focusin",H),t.removeEventListener("focusout",M))}));const q=e=>{r(b,e)},B=e=>r(k,e),H=t=>{const n=d(i);if(!n)return;const o=t.target,s=t.relatedTarget,a=o&&n.contains(o);if(!e.trapped){s&&n.contains(s)||(p=s)}a&&r("focusin",t),C.paused||e.trapped&&(a?m=o:_(m,!0))},M=t=>{const n=d(i);if(!C.paused&&n)if(e.trapped){const o=t.relatedTarget;v(o)||n.contains(o)||setTimeout((()=>{if(!C.paused&&e.trapped){const e=j({focusReason:T.value});r("focusout-prevented",e),e.defaultPrevented||_(m,!0)}}),0)}else{const e=t.target;e&&n.contains(e)||r("focusout",t)}};async function U(){await l();const t=d(i);if(t){x.push(C);const n=t.contains(document.activeElement)?p:document.activeElement;p=n;if(!t.contains(n)){const o=new Event(w,h);t.addEventListener(w,q),t.dispatchEvent(o),o.defaultPrevented||l((()=>{let o=e.focusStartEl;f(o)||(_(o),document.activeElement!==o&&(o="first")),"first"===o&&((e,t=!1)=>{const n=document.activeElement;for(const o of e)if(_(o,t),document.activeElement!==n)return})(N(t),!0),document.activeElement!==n&&"container"!==o||_(t)}))}}}function V(){const e=d(i);if(e){e.removeEventListener(w,q);const t=new CustomEvent(L,{...h,detail:{focusReason:T.value}});e.addEventListener(L,B),e.dispatchEvent(t),t.defaultPrevented||"keyboard"!=T.value&&F.value>K.value&&!e.contains(document.activeElement)||_(null!=p?p:document.body),e.removeEventListener(L,q),x.remove(C)}}return t((()=>{e.trapped&&U(),c((()=>e.trapped),(e=>{e?U():V()}))})),o((()=>{e.trapped&&V()})),{onKeydown:D}}}),[["render",function(e,t,n,o,s,a){return p(e.$slots,"default",{handleKeydown:e.onKeydown})}],["__file","/home/runner/work/element-plus/element-plus/packages/components/focus-trap/src/focus-trap.vue"]]);export{D as E,R as F,m as c};
